
    <!DOCTYPE html>
    <html>
    <head>
        <title>Chat Application</title>
        <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
        <style>
            body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
            #chat-container { border: 1px solid #ddd; border-radius: 5px; padding: 10px; }
            #messages { height: 400px; overflow-y: auto; margin-bottom: 10px; padding: 10px; border: 1px solid #eee; }
            #message-form { display: flex; gap: 10px; }
            #message-input { flex-grow: 1; padding: 8px; }
            #username-input { padding: 8px; width: 200px; }
            button { padding: 8px 15px; background: #4CAF50; color: white; border: none; cursor: pointer; }
            button:hover { background: #45a049; }
            .message { margin-bottom: 10px; padding: 8px; background: #f9f9f9; border-radius: 4px; }
            .message .sender { font-weight: bold; color: #333; }
            .message .time { font-size: 0.8em; color: #999; margin-left: 10px; }
            .system-message { color: #666; font-style: italic; }
        </style>
    </head>
    <body>
        <div id="chat-container">
            <div id="user-section">
                <input type="text" id="username-input" placeholder="Enter your username">
                <button onclick="setUsername()">Join Chat</button>
            </div>
            <div id="messages"></div>
            <div id="message-form" style="display:none;">
                <input type="text" id="message-input" placeholder="Type your message here">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>

        <script>
            const socket = io();
            let currentUsername = '';

            // Обработчики событий
            socket.on('connect', () => {
                console.log('Connected to server');
            });

            socket.on('broadcast_message', (data) => {
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                messageElement.innerHTML = `
                    <span class="sender">${data.sender}:</span>
                    <span class="time">${data.time}</span>
                    <div>${data.text}</div>
                `;
                document.getElementById('messages').appendChild(messageElement);
                scrollToBottom();
            });

            socket.on('system_message', (data) => {
                const messageElement = document.createElement('div');
                messageElement.className = 'system-message';
                messageElement.textContent = data.text;
                document.getElementById('messages').appendChild(messageElement);
                scrollToBottom();
            });

            socket.on('user_list', (data) => {
                console.log('Online users:', data.users);
            });

            socket.on('user_connected', (data) => {
                addSystemMessage(`${data.username} joined the chat`);
            });

            socket.on('user_disconnected', (data) => {
                addSystemMessage(`${data.username} left the chat`);
            });

            socket.on('message_history', (data) => {
                data.messages.forEach(msg => {
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message';
                    messageElement.innerHTML = `
                        <span class="sender">${msg.sender}:</span>
                        <span class="time">${msg.time}</span>
                        <div>${msg.text}</div>
                    `;
                    document.getElementById('messages').appendChild(messageElement);
                });
                scrollToBottom();
            });

            // Функции
            function setUsername() {
                const username = document.getElementById('username-input').value.trim();
                if (username) {
                    currentUsername = username;
                    socket.emit('set_username', { username });
                    document.getElementById('user-section').style.display = 'none';
                    document.getElementById('message-form').style.display = 'flex';
                    addSystemMessage(`Welcome, ${username}!`);
                }
            }

            function sendMessage() {
                const input = document.getElementById('message-input');
                const message = input.value.trim();
                if (message) {
                    socket.emit('new_message', { text: message });
                    input.value = '';
                }
            }

            function addSystemMessage(text) {
                const messageElement = document.createElement('div');
                messageElement.className = 'system-message';
                messageElement.textContent = text;
                document.getElementById('messages').appendChild(messageElement);
                scrollToBottom();
            }

            function scrollToBottom() {
                const messagesDiv = document.getElementById('messages');
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            // Обработка нажатия Enter
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            document.getElementById('username-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    setUsername();
                }
            });
        </script>
    </body>
    </html>
    